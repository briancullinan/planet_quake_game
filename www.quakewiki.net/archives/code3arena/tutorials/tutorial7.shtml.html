<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>

<head>
<title>Code3Arena</title>
</head>
<body background="../images/bg.gif" bgcolor="#660000" text="white" link="#C05F00" vlink="#d16545"><script type="text/javascript">document.write('<script type="text/javascript" src="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=prestitial"></scr' + 'ipt>');</script>

<table width="100%" border=0 cellpadding=5 cellspacing=0 align="center" background="../images/bg.gif">
<tr>
<td width=728 height=90 align="CENTER" valign="top" bgcolor=#000000>
<center><script language="javascript" type="text/javascript"> 
document.write("<"+"script type='text/javascript' src='http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90'>"); 
document.write("<"+"/script>"); 
</script>
<noscript> 
<iframe valign=top WIDTH=728 HEIGHT=90 MARGINWIDTH=0 MARGINHEIGHT=0 HSPACE=0 VSPACE=0 FRAMEBORDER=0 SCROLLING=no BORDERCOLOR="#000000" SRC="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90&amp;sizew=728&amp;sizeh=90&amp;js=false"> 
</iframe> 
</noscript> </center>
</td>
</tr>
</table>

<br>

<table width="100%" cellspacing="0" cellpadding="0" border="1" align="center" bgcolor=#000000>
<tr>
<td align="CENTER">
<img src="../images/logo.gif" width="500" height="137" border="0" alt="Code3Arena">
</td>
</tr>
</table>

<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial6.shtml.html"><< Prev</a> |
Tutorial 7 |
<a href="tutorial8.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>


<table width="100%" border=0 cellpadding=0 cellspacing=0 align=center bgcolor=#4B0202>
<tr>

<td valign=top bgcolor="#000000">
<table width=150 bgcolor="#000000" valign=top border=0 cellpadding=10 cellspacing=0>
<tr>
<td bgcolor=#000000 valign=top>
<p>
<a href="https://www.quakewiki.net/archives/code3arena/index.shtml"><img src="../images/minilogo.gif" width="150" height="80" border="0" alt="menu"></a>
<p>
<font face=arial color="#C05F00" size=2>
<strong>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/index.shtml">Home/News</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/modsource.shtml">ModSource</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/compilers.shtml">Compiling</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/help.shtml">Help!!!</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/submission.shtml">Submission</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/contributors.shtml">Contributors</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/staff.shtml">Staff</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/downloads.shtml">Downloads</a>
</strong>
<P>
<img src="../images/tutorials.gif" width="80" height="25" border="0" alt="Tutorials">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="index.html"> < Index ></a>
<BR> 1. <a href="tutorial1.shtml.html">Mod making 101</a>
<BR> 2. <a href="tutorial2.shtml.html">Up 'n running</a>
<BR> 3. <a href="tutorial3.shtml.html">Hello, QWorld!</a>
<BR> 4. <a href="tutorial4.shtml.html">Infinite Haste</a>
<BR> 5. <a href="tutorial5.shtml.html">Armor Piercing Rails</a>
<BR> 6. <a href="tutorial6.shtml.html">Bouncing Rockets</a>
<BR> 7. <a href="tutorial7.shtml.html">Cloaking</a>
<BR> 8. <a href="tutorial8.shtml.html">Ladders</a>
<BR> 9. <a href="tutorial9.shtml.html">Favourite Server</a>
<BR> 10. <a href="tutorial10.shtml.html">Flame Thrower</a>
<BR> 11. <a href="tutorial11.shtml.html">Vortex Grenades</a>
<BR> 12. <a href="tutorial12.shtml.html">Grapple</a>
<BR> 13. <a href="tutorial13.shtml.html">Lightning Discharge</a>
<BR> 14. <a href="tutorial14.shtml.html">Locational Damage</a>
<BR> 15. <a href="tutorial15.shtml.html">Leg Shots</a>
<BR> 16. <a href="tutorial16.shtml.html">Weapon Switching</a>
<BR> 17. <a href="tutorial17.shtml.html">Scoreboard frag-rate</a>
<BR> 18. <a href="tutorial18.shtml.html">Vortex Grenades II</a>
<BR> 19. <a href="tutorial19.shtml.html">Vulnerable Missiles</a>
<BR> 20. <a href="tutorial20.shtml.html">Creating Classes</a>
<BR> 21. <a href="tutorial21.shtml.html">Scrolling Credits</a>
<BR> 22. <a href="tutorial22.shtml.html">Weapon Dropping</a>
<BR> 23. <a href="tutorial23.shtml.html">Anti-Gravity Boots</a>
<BR> 24. <a href="tutorial24.shtml.html">HUD scoreboard</a>
<BR> 25. <a href="tutorial25.shtml.html">Flashlight and laser</a>
<BR> 26. <a href="tutorial26.shtml.html">Weapon Positioning</a>
<BR> 27. <a href="tutorial27.shtml.html">Weapon Reloading</a>
<BR> 28. <a href="tutorial28.shtml.html">Progressive Zooming</a>
<BR> 29. <a href="tutorial29.shtml.html">Rotating Doors</a>
<BR> 30. <a href="tutorial30.shtml.html">Beheading (headshot!)</a>
<BR> 31. <a href="tutorial31.shtml.html">Alt Weapon Fire</a>
<BR> 32. <a href="tutorial32.shtml.html">Popup Menus I</a>
<BR> 33. <a href="tutorial33.shtml.html">Popup Menus II</a>
<BR> 34. <a href="tutorial34.shtml.html">Cluster Grenades</a>
<BR> 35. <a href="tutorial35.shtml.html">Homing Rockets</a>
<BR> 36. <a href="tutorial36.shtml.html">Spreadfire Powerup</a>
<BR> 37. <a href="tutorial37.shtml.html">Instagib gameplay</a>
<BR> 38. <a href="tutorial38.shtml.html">Accelerating rockets</a>
<BR> 39. <a href="tutorial39.shtml.html">Server only Instagib</a>
<BR> 40. <a href="tutorial40.shtml.html">Advanced Grapple Hook</a>
<BR> 41. <a href="tutorial41.shtml.html">Unlagging your mod</a>
</strong>
</font>
<p><br>
<img src="../images/articles.gif" width="80" height="25" border="0" alt="Articles">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="https://www.quakewiki.net/archives/code3arena/articles/index.html"> < Index > </a>
<BR> 1. <a href="https://www.quakewiki.net/archives/code3arena/articles/article1.shtml">Entities</A>
<BR> 2. <a href="https://www.quakewiki.net/archives/code3arena/articles/article2.shtml">Vectors</A>
<BR> 3. <a href="https://www.quakewiki.net/archives/code3arena/articles/article3.shtml">Good Coding</A>
<BR> 4. <a href="https://www.quakewiki.net/archives/code3arena/articles/article4.shtml">Compilers I</A>
<BR> 5. <a href="https://www.quakewiki.net/archives/code3arena/articles/article5.shtml">Compilers II</A>
<BR> 6. <a href="https://www.quakewiki.net/archives/code3arena/articles/article6.shtml">UI Menu Primer I</A>
<BR> 7. <a href="https://www.quakewiki.net/archives/code3arena/articles/article7.shtml">UI Menu Primer II</A>
<BR> 8. <a href="https://www.quakewiki.net/archives/code3arena/articles/article8.shtml">UI Menu Primer III</A>
<BR> 9. <a href="https://www.quakewiki.net/archives/code3arena/articles/article9.shtml">QVM Communication, Cvars, commands</A>
<BR> 10. <a href="https://www.quakewiki.net/archives/code3arena/articles/article10.shtml">Metrowerks CodeWarrior</A>
<BR> 11. <a href="https://www.quakewiki.net/archives/code3arena/articles/article11.shtml">1.27g code, bugs, batch</A>
</strong>
</font>
<p>

<br>
<img src="../images/links.gif" width="80" height="25" border="0" alt="Links">
<font color="#C05F00">
<small>
<li><a href="http://www.planetquake.com/quake3/files.shtml">Quake3 Files</a>
<li><a href="http://forums.planetquake.com/">Quake3 Forums</a>
<li><a href="tutorial7.shtml.html#">Q3A Editing Message Board</a>
<li><a href="http://www.planetquake.com/quake3/hosted/editing.shtml">Quake3 Editing</a>
</small>
</font>
<p><br>
<img src="../images/feedback.gif" width="80" height="25" border="0" alt="Feedback">
<font color="#C05F00">
<small>
<li><a href="mailto:sumfuka@planetquake.com">SumFuka</A>
<li><a href="mailto:calrathan@captured.com">Calrathan</A>
<li><a href="mailto:hypothermia@planetquake.com">
<font color="#FF0000">H</font><font color="#FFFF00">y</font><font color="#CC33CC">p</font><font color="#3333FF">o</font>Thermia
</A>
<li><a href="mailto:warzone@planetquake.com">WarZone</A>
</small>
</font>
<p><br>
<p><br><br><br>
<small>Site Design by:</small>
<br>
<a href="mailto:ladyice@planetice.org,jeh@planetjeh.com"><img src="../images/icelogo_sm.jpg" width="88" height="31" border="0" align="middle" alt="ICEmosis Design"></a>
</font>
<br><br>
</td>
</tr>
</table>
</td>


<td valign=top background="../images/bg.gif">
<table width=20 cellpadding=0 cellspacing=0 border=0 background="../images/bg.gif">
<tr>
<td background="../images/bg.gif">
&nbsp;
</td>
</tr>
</table>
</td>


<td valign=top bgcolor=#000000>
<table width="100%" cellpadding=15 cellspacing=10 border=0 bgcolor=#000000 valign=top>
<tr>
<td valign=top>
<font face="Verdana, Arial" size="2" color="#eeeeee">
<center><b><font color="#C05F00" size=5>
TUTORIAL 7 - Cloaking
</font></b><br>by <b><a href="https://www.quakewiki.net/archives/code3arena/staff/asskicka.shtml">AssKicka</A></b></center><p>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">Teach those bots a lesson, Predator-style !<br>
Let's add a nice cloaking feature that also decrements the players health while cloaked. </font></p>
</center>
<h4><font color="#e07f44" face="Verdana,Arial">
1. ADDING A NEW ENTITY FLAG.
</font></h4>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">First we are going to add a new entity flag called FL_CLOAK that we will use to activate and deactivate our cloaking. Open up g_local.h and add the code bellow after line 32.</font></p>
<pre><font face="Verdana,Arial" size="2" color="#ffffcc">#define FL_NO_HUMANS       0x00004000     // spawn point just for bots</font>
<font color="#ff6060" face="Verdana,Arial" size="2">#define FL_CLOAK               0x00010000     // health cloaking</font></pre>
<h4><font color="#e07f44" face="Verdana,Arial">2. CREATING A NEW CONSOLE COMMAND.</font></h4>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">Open up g_cmds.c and add the code bellow after line 1022</font></p>
<pre><font color="#ff6060" face="Verdana,Arial" size="2">/*</font>
<font color="#ff6060" face="Verdana,Arial" size="2">=================</font>
<font color="#ff6060" face="Verdana,Arial" size="2">Cmd_Cloak_f</font>
<font color="#ff6060" face="Verdana,Arial" size="2">=================</font>
<font color="#ff6060" face="Verdana,Arial" size="2">*/</font>
<font color="#ff6060" face="Verdana,Arial" size="2">void Cmd_Cloak_f( gentity_t *ent ) {</font>

<font color="#ff6060" face="Verdana,Arial" size="2">	char *msg; // message to player</font>

<font color="#ff6060" face="Verdana,Arial" size="2">	ent-&gt;flags ^= FL_CLOAK;</font>

<font color="#ff6060" face="Verdana,Arial" size="2">	if (!(ent-&gt;flags &amp; FL_CLOAK)) {</font>
<font color="#ff6060" face="Verdana,Arial" size="2">		msg = &quot;Cloaking OFF\n&quot;;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">		ent-&gt;client-&gt;ps.powerups[PW_INVIS] = level.time;
		// Removes the invisible powerup from the player</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	}        </font>
<font color="#ff6060" face="Verdana,Arial" size="2">	else {</font>
<font color="#ff6060" face="Verdana,Arial" size="2">		msg = &quot;Cloaking ON\n&quot;;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">		ent-&gt;client-&gt;ps.powerups[PW_INVIS] = level.time + 1000000000;
		// Gives the invisible powerup to the player</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	}</font>

<font color="#ff6060" face="Verdana,Arial" size="2">	trap_SendServerCommand( ent-g_entities, va(&quot;print \&quot;%s\&quot;&quot;, msg));</font>
<font color="#ff6060" face="Verdana,Arial" size="2">}</font></pre>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">All we did here is create a new function that is called when you use the /cloak command that we will be adding bellow. This function will change the current state of FL_CLOAK, activate/deactivate the invisible powerup and print a relative on/off message to the player.<P>
What the hell is &quot;level.time + 1000000000&quot; ? What we are doing is making the invisible powerup last for 1666 minutes. We don't really need it to last that long because we will be decrementing the players health until it reaches 10 and then auto deactivating cloaking. </font></p>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">Now we must add the /cloak console command and get it to call the function we created. Goto line 1095 and add the code bellow</font></p>
<pre><font face="Verdana,Arial" size="2" color="#ffffcc">else if (Q_stricmp (cmd, &quot;setviewpos&quot;) == 0)</font>
<font face="Verdana,Arial" size="3" color="#ffffcc">	</font><font face="Verdana,Arial" size="2" color="#ffffcc">Cmd_SetViewpos_f( ent );</font>
<font color="#ff6060" face="Verdana,Arial" size="2">else if (Q_stricmp (cmd, &quot;cloak&quot;) == 0)</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	Cmd_Cloak_f( ent );</font></pre>
<h4><font color="#e07f44" face="Verdana,Arial">3. MAKING THE CLIENTS HEALTH DECREMENT WHILE CLOAKED.</font></h4>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">We will now make the players health decrement every second while cloaking is enabled. open g_active.c and goto line 397 in ClientTimeActions. This function will be called once every second, making it perfect for our cloaking feautre. Modify the existing code </font></p>
<pre><font face="Verdana,Arial" size="2" color="#ffffcc">// count down health when over max</font>
<font face="Verdana,Arial" size="2" color="#ffffcc">if ( ent-&gt;health &gt; client-&gt;ps.stats[STAT_MAX_HEALTH] ) {</font>
<font face="Verdana,Arial" size="2" color="#ffffcc">	ent-&gt;health--;</font></pre>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">to match the following code :</font></p>
<pre><font color="#ff6060" face="Verdana,Arial" size="2">if (!(ent-&gt;flags &amp; FL_CLOAK)) {</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	// count down health when over max and not cloaked.</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	if ( ent-&gt;health &gt; client-&gt;ps.stats[STAT_MAX_HEALTH] ) { </font>
<font color="#ff6060" face="Verdana,Arial" size="2">		ent-&gt;health--;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	}</font>
<font color="#ff6060" face="Verdana,Arial" size="2">} </font>
<font color="#ff6060" face="Verdana,Arial" size="2">else {</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	// count down health when cloaked.</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	ent-&gt;health--;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	if ( ent-&gt;health &lt; 11) {</font>
<font color="#ff6060" face="Verdana,Arial" size="2">		ent-&gt;flags ^= FL_CLOAK;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">		ent-&gt;client-&gt;ps.powerups[PW_INVIS] = level.time;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	}</font>
<font color="#ff6060" face="Verdana,Arial" size="2">}</font></pre>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">Lets look at what we have done. First we check if FL_CLOAK is enabled, if it is <b>NOT</b> we then check if the players health is <b>MORE</b> than 100 (STAT_MAX_HEALTH), If it <b>IS</b> we decrement the players health. If the player is cloaked the &quot;else&quot; section is executed, meaning the players health is decremented. The reason we do it this way is because we do not want the players health to decrement by 2 if he is cloaked and his health is above STAT_MAX_HEALTH. We have also forced cloaking off when the players health reaches 10.</font></p>
<h4><font color="#e07f44" face="Verdana,Arial">4. DON'T DROP POWER-UPS WHILE CLOAKED.</font></h4>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">The next step is to remove the cloak powerup just before the normal powerups are dropped when the player dies. We need to do this because if a player died while he was cloaked, the invisible powerup will pop up and the next player who picks it up will have unlimited invisibility, without his health decrementing (bit unfair don't you think).</font></p>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">Open g_combat.c and goto line 67, now add the code bellow :</font></p>
<pre><font color="#ff6060" face="Verdana,Arial" size="2">if (self-&gt;flags &amp; FL_CLOAK) {</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	// remove the invisible powerup if the player is cloaked.</font>
<font color="#ff6060" face="Verdana,Arial" size="2">	self-&gt;client-&gt;ps.powerups[PW_INVIS] = level.time;</font>
<font color="#ff6060" face="Verdana,Arial" size="2">}</font><font face="Verdana,Arial" size="2" color="#eeeeee"> </font></pre>
<center>
<p><font face="Verdana,Arial" size="2" color="#eeeeee">That's it, create your .qvm file and enjoy being the preditor !</font></center>
<p>
</td>
</tr>
</table>

</tr>
</table>
<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial6.shtml.html"><< Prev</a> |
Tutorial 7 |
<a href="tutorial8.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>

</body>

</html>
