<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>

<head>
<title>Code3Arena</title>
</head>
<body background="../images/bg.gif" bgcolor="#660000" text="white" link="#C05F00" vlink="#d16545"><script type="text/javascript">document.write('<script type="text/javascript" src="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=prestitial"></scr' + 'ipt>');</script>

<table width="100%" border=0 cellpadding=5 cellspacing=0 align="center" background="../images/bg.gif">
<tr>
<td width=728 height=90 align="CENTER" valign="top" bgcolor=#000000>
<center><script language="javascript" type="text/javascript"> 
document.write("<"+"script type='text/javascript' src='http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90'>"); 
document.write("<"+"/script>"); 
</script>
<noscript> 
<iframe valign=top WIDTH=728 HEIGHT=90 MARGINWIDTH=0 MARGINHEIGHT=0 HSPACE=0 VSPACE=0 FRAMEBORDER=0 SCROLLING=no BORDERCOLOR="#000000" SRC="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90&amp;sizew=728&amp;sizeh=90&amp;js=false"> 
</iframe> 
</noscript> </center>
</td>
</tr>
</table>

<br>

<table width="100%" cellspacing="0" cellpadding="0" border="1" align="center" bgcolor=#000000>
<tr>
<td align="CENTER">
<img src="../images/logo.gif" width="500" height="137" border="0" alt="Code3Arena">
</td>
</tr>
</table>

<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial34.shtml.html"><< Prev</a> |
Tutorial 35 |
<a href="tutorial36.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>


<table width="100%" border=0 cellpadding=0 cellspacing=0 align=center bgcolor=#4B0202>
<tr>

<td valign=top bgcolor="#000000">
<table width=150 bgcolor="#000000" valign=top border=0 cellpadding=10 cellspacing=0>
<tr>
<td bgcolor=#000000 valign=top>
<p>
<a href="https://www.quakewiki.net/archives/code3arena/index.shtml"><img src="../images/minilogo.gif" width="150" height="80" border="0" alt="menu"></a>
<p>
<font face=arial color="#C05F00" size=2>
<strong>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/index.shtml">Home/News</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/modsource.shtml">ModSource</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/compilers.shtml">Compiling</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/help.shtml">Help!!!</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/submission.shtml">Submission</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/contributors.shtml">Contributors</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/staff.shtml">Staff</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/downloads.shtml">Downloads</a>
</strong>
<P>
<img src="../images/tutorials.gif" width="80" height="25" border="0" alt="Tutorials">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="index.html"> < Index ></a>
<BR> 1. <a href="tutorial1.shtml.html">Mod making 101</a>
<BR> 2. <a href="tutorial2.shtml.html">Up 'n running</a>
<BR> 3. <a href="tutorial3.shtml.html">Hello, QWorld!</a>
<BR> 4. <a href="tutorial4.shtml.html">Infinite Haste</a>
<BR> 5. <a href="tutorial5.shtml.html">Armor Piercing Rails</a>
<BR> 6. <a href="tutorial6.shtml.html">Bouncing Rockets</a>
<BR> 7. <a href="tutorial7.shtml.html">Cloaking</a>
<BR> 8. <a href="tutorial8.shtml.html">Ladders</a>
<BR> 9. <a href="tutorial9.shtml.html">Favourite Server</a>
<BR> 10. <a href="tutorial10.shtml.html">Flame Thrower</a>
<BR> 11. <a href="tutorial11.shtml.html">Vortex Grenades</a>
<BR> 12. <a href="tutorial12.shtml.html">Grapple</a>
<BR> 13. <a href="tutorial13.shtml.html">Lightning Discharge</a>
<BR> 14. <a href="tutorial14.shtml.html">Locational Damage</a>
<BR> 15. <a href="tutorial15.shtml.html">Leg Shots</a>
<BR> 16. <a href="tutorial16.shtml.html">Weapon Switching</a>
<BR> 17. <a href="tutorial17.shtml.html">Scoreboard frag-rate</a>
<BR> 18. <a href="tutorial18.shtml.html">Vortex Grenades II</a>
<BR> 19. <a href="tutorial19.shtml.html">Vulnerable Missiles</a>
<BR> 20. <a href="tutorial20.shtml.html">Creating Classes</a>
<BR> 21. <a href="tutorial21.shtml.html">Scrolling Credits</a>
<BR> 22. <a href="tutorial22.shtml.html">Weapon Dropping</a>
<BR> 23. <a href="tutorial23.shtml.html">Anti-Gravity Boots</a>
<BR> 24. <a href="tutorial24.shtml.html">HUD scoreboard</a>
<BR> 25. <a href="tutorial25.shtml.html">Flashlight and laser</a>
<BR> 26. <a href="tutorial26.shtml.html">Weapon Positioning</a>
<BR> 27. <a href="tutorial27.shtml.html">Weapon Reloading</a>
<BR> 28. <a href="tutorial28.shtml.html">Progressive Zooming</a>
<BR> 29. <a href="tutorial29.shtml.html">Rotating Doors</a>
<BR> 30. <a href="tutorial30.shtml.html">Beheading (headshot!)</a>
<BR> 31. <a href="tutorial31.shtml.html">Alt Weapon Fire</a>
<BR> 32. <a href="tutorial32.shtml.html">Popup Menus I</a>
<BR> 33. <a href="tutorial33.shtml.html">Popup Menus II</a>
<BR> 34. <a href="tutorial34.shtml.html">Cluster Grenades</a>
<BR> 35. <a href="tutorial35.shtml.html">Homing Rockets</a>
<BR> 36. <a href="tutorial36.shtml.html">Spreadfire Powerup</a>
<BR> 37. <a href="tutorial37.shtml.html">Instagib gameplay</a>
<BR> 38. <a href="tutorial38.shtml.html">Accelerating rockets</a>
<BR> 39. <a href="tutorial39.shtml.html">Server only Instagib</a>
<BR> 40. <a href="tutorial40.shtml.html">Advanced Grapple Hook</a>
<BR> 41. <a href="tutorial41.shtml.html">Unlagging your mod</a>
</strong>
</font>
<p><br>
<img src="../images/articles.gif" width="80" height="25" border="0" alt="Articles">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="https://www.quakewiki.net/archives/code3arena/articles/index.html"> < Index > </a>
<BR> 1. <a href="https://www.quakewiki.net/archives/code3arena/articles/article1.shtml">Entities</A>
<BR> 2. <a href="https://www.quakewiki.net/archives/code3arena/articles/article2.shtml">Vectors</A>
<BR> 3. <a href="https://www.quakewiki.net/archives/code3arena/articles/article3.shtml">Good Coding</A>
<BR> 4. <a href="https://www.quakewiki.net/archives/code3arena/articles/article4.shtml">Compilers I</A>
<BR> 5. <a href="https://www.quakewiki.net/archives/code3arena/articles/article5.shtml">Compilers II</A>
<BR> 6. <a href="https://www.quakewiki.net/archives/code3arena/articles/article6.shtml">UI Menu Primer I</A>
<BR> 7. <a href="https://www.quakewiki.net/archives/code3arena/articles/article7.shtml">UI Menu Primer II</A>
<BR> 8. <a href="https://www.quakewiki.net/archives/code3arena/articles/article8.shtml">UI Menu Primer III</A>
<BR> 9. <a href="https://www.quakewiki.net/archives/code3arena/articles/article9.shtml">QVM Communication, Cvars, commands</A>
<BR> 10. <a href="https://www.quakewiki.net/archives/code3arena/articles/article10.shtml">Metrowerks CodeWarrior</A>
<BR> 11. <a href="https://www.quakewiki.net/archives/code3arena/articles/article11.shtml">1.27g code, bugs, batch</A>
</strong>
</font>
<p>

<br>
<img src="../images/links.gif" width="80" height="25" border="0" alt="Links">
<font color="#C05F00">
<small>
<li><a href="http://www.planetquake.com/quake3/files.shtml">Quake3 Files</a>
<li><a href="http://forums.planetquake.com/">Quake3 Forums</a>
<li><a href="tutorial35.shtml.html#">Q3A Editing Message Board</a>
<li><a href="http://www.planetquake.com/quake3/hosted/editing.shtml">Quake3 Editing</a>
</small>
</font>
<p><br>
<img src="../images/feedback.gif" width="80" height="25" border="0" alt="Feedback">
<font color="#C05F00">
<small>
<li><a href="mailto:sumfuka@planetquake.com">SumFuka</A>
<li><a href="mailto:calrathan@captured.com">Calrathan</A>
<li><a href="mailto:hypothermia@planetquake.com">
<font color="#FF0000">H</font><font color="#FFFF00">y</font><font color="#CC33CC">p</font><font color="#3333FF">o</font>Thermia
</A>
<li><a href="mailto:warzone@planetquake.com">WarZone</A>
</small>
</font>
<p><br>
<p><br><br><br>
<small>Site Design by:</small>
<br>
<a href="mailto:ladyice@planetice.org,jeh@planetjeh.com"><img src="../images/icelogo_sm.jpg" width="88" height="31" border="0" align="middle" alt="ICEmosis Design"></a>
</font>
<br><br>
</td>
</tr>
</table>
</td>


<td valign=top background="../images/bg.gif">
<table width=20 cellpadding=0 cellspacing=0 border=0 background="../images/bg.gif">
<tr>
<td background="../images/bg.gif">
&nbsp;
</td>
</tr>
</table>
</td>


<td valign=top bgcolor=#000000>
<table width="100%" cellpadding=15 cellspacing=10 border=0 bgcolor=#000000 valign=top>
<tr>
<td valign=top>
<font face="Verdana, Arial" size="2" color="#eeeeee">
<center><b><font color="#C05F00" size=5>
TUTORIAL 35 - Homing Rockets
</font></b><br>by <b><a href="mailto:chris@dctank.com">Chris Hilton</A></b></center>
<p>Continuing on the weapon power-up theme, and taking another look at
the <a href="https://www.quakewiki.net/archives/code3arena/modsource.shtml">MaxCarnage</a> mini-mod, we're
looking at rockets that home on their target.
<p>Rockets are already a powerful weapon... the splash damage gives the
target a "kick" that makes it easier to place the second rocket, getting
the frag. This is balanced in the tutorial by slowing the rockets down
and giving them a tunnel vision view of their target.
<p>There are also some important issues for playing this modification
over a network versus a 56K modem. Quake 3 uses a &quot;fire and
forget&quot; system that allows the client to predict where an object
will be if its path isn't interrupted. This smooths gameplay and greatly
reduces the amount of data sent across a network connection, and is
equivalent to long think times for entities.
<p>Implementing homing missiles will hammer this: a short think time means the
rocket entity will frequently update its direction vector while tracking. 56K
modem users will be greatly disadvantaged by this, so think carefully about
whether you want to implement this in a mod for general release.
<p>Chris Hilton wrote the code and donated the mod source to Code3Arena,
and <font color="#FF0000">H</font><font color="#FFFF00">y</font><font color="#CC33CC">p</font><font color="#3333FF">o</font><font color="#FFFFFF">Thermia</font> wrote these words. I've also added a
small bug fix to the code that isn't in the source released, you're
unlikely to notice it in play though.
<font color="#E07F44"><H4>
1. About homing rockets
</H4></font>
<p>The concept of a homing rocket is a straight forward one, but I'll
cover the details here so you can see why Chris has written the code the
way he has. The most important thing is restricting the visibility of
targets to the rocket. This is done by only using targets within a
certain range of the rocket, and within a given cone of view based on
the current direction of travel.
<p>The rockets also aim at the midbody, rather than the feet or one corner of
the model. A bit of common sense really, but attention to detail like this makes
for a better mod.
<font color="#E07F44"><H4>
2. Implementing the code
</H4></font>
<p>All the modifications take place in <b>g_missile.c</b>, we're just adding
a new think function for the rocket, and updating the rocket creation code so
it uses the new think function.
<p>First off we've got the new &quote;think&quot; function. It needs a little bit
of explanation, and should be placed before the <b>fire_rocket()</b> function.
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre><font color="#ff6060">/*
================
CCH: rocket_think

Fly like an eagle...
--"Fly Like an Eagle", Steve Miller Band
================
*/
#define ROCKET_SPEED	600

void rocket_think( gentity_t *ent ) {
	gentity_t	*target, *tent;
	float		targetlength, tentlength;
	int		i;
	vec3_t		tentdir, targetdir, forward, midbody;
	trace_t		tr;

	target = NULL;
	targetlength = LIGHTNING_RANGE;
	// Best way to get forward vector for this rocket?
	VectorCopy(ent->s.pos.trDelta, forward);
	VectorNormalize(forward);
	for (i = 0; i < level.maxclients; i++) {
		// Here we use tent to point to potential targets
		tent = &g_entities[i];

		if (!tent->inuse) continue;
		if (tent == ent->parent) continue;
		if ( OnSameTeam( tent, ent->parent ) ) continue;

		// Aim for the body, not the feet
		midbody[0] = tent->r.currentOrigin[0] + 
			(tent->r.mins[0] + tent->r.maxs[0]) * 0.5;
		midbody[1] = tent->r.currentOrigin[1] + 
			(tent->r.mins[1] + tent->r.maxs[1]) * 0.5;
		midbody[2] = tent->r.currentOrigin[2] + 
			(tent->r.mins[2] + tent->r.maxs[2]) * 0.5;

		VectorSubtract(midbody, ent->r.currentOrigin, tentdir);
		tentlength = VectorLength(tentdir);
		if ( tentlength > targetlength ) continue;

		// Quick normalization of tentdir since 
		// we already have the length
		tentdir[0] /= tentlength;
		tentdir[1] /= tentlength;
		tentdir[2] /= tentlength;
		if ( DotProduct(forward, tentdir) < 0.9 ) continue;

		trap_Trace( &tr, ent->r.currentOrigin, NULL, NULL, 
			tent->r.currentOrigin, ENTITYNUM_NONE, MASK_SHOT );

		if ( tent != &g_entities[tr.entityNum] ) continue;

		target = tent;
		targetlength = tentlength;
		VectorCopy(tentdir, targetdir);
	}

	ent->nextthink += 50;

	if (!target) return;

	VectorMA(forward, 0.05, targetdir, targetdir);
	VectorNormalize(targetdir);
	VectorScale(targetdir, ROCKET_SPEED, ent->s.pos.trDelta);
}</font>
</pre></font>
<p>Stepping through the code, we first set in <b>targetlength</b> how far ahead of
the rocket we'll look for targets, and also grab the direction the rocket is currently
flying in.
<p>Then, looping through all the player entities on the map, we apply a several
conditions for rejecting the target. These conditions are:
<ol>
<li>That the entity is on the map (<b>tent->inuse</b>),
<li>not the person firing the rocket (<b>tent == ent-&gt;parent</b>),
<li>not on the same team as the person firing the rocket,
<li>not too far away (<b>tentlength &gt; targetlength</b>),
<li>inside the visible cone (<b>DotProduct(forward, tentdir) &lt; 0.9</b>), and
<li>not obscured by part of the map (<b>trap_Trace()</b>).
</ol>
<p>The small bug-fix is in the way <b>tentlength</b> is used to
normalize the value of <b>tentdir[]</b>, and allows the code to find the
closest target player properly.
<p>The visible cone test uses a little bit of vector math to obtain the
cosine of the angle between the two vectors. The value of 0.9 accepts
all vectors that differ by up to 25 degrees. Increasing this value
closer to 1.0 will narrow the cone, reducing it towards zero will open
the cone up.
<p>Care needs to be taken with size of the cone: there's no code to
remove the rocket when its been on the map for a while, it needs to hit
something to be removed. You need to use sensible values that allow the
rocket to &quot;miss&quot; and so be removed from the map.
<p>Finally, when the closest target has been found, the direction to the
target is mixed with the current direction using <b>VectorMA()</b> so
the rocket starts steering towards its victim. Decreasing the value of
0.05 will give the rocket a larger turning circle and make it less
responsive. Increase the value too much and the player won't have a
chance to get out the way!
<p>&nbsp;
<p>All thats left is to link this new think function into the rocket and
set the new slower speed at the time of launch. These last two changes go into
<b>fire_rocket()</b>.
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
bolt = G_Spawn();
bolt->classname = "rocket";
bolt->nextthink = <font color="#ff6060">level.time + 1;	// CCH</font>
bolt->think = <font color="#ff6060">rocket_think;		// CCH</font>
bolt->s.eType = ET_MISSILE;
bolt->r.svFlags = SVF_USE_CURRENT_ORIGIN;


bolt->s.pos.trType = TR_LINEAR;
bolt->s.pos.trTime = level.time - MISSILE_PRESTEP_TIME;
VectorCopy( start, bolt->s.pos.trBase );
VectorScale( dir, <font color="#ff6060">ROCKET_SPEED</font>, bolt->s.pos.trDelta );	// CCH
SnapVector( bolt->s.pos.trDelta );
VectorCopy (start, bolt->r.currentOrigin);
</pre></font>
<p>&nbsp;
<font color="#E07F44"><H4>
3. Ideas for change
</H4></font>
<p>Just to round off the tutorial, I thought I'd give a few ideas on the changes you could
make to the this code.
<p>The most obvious is making sure that the missile doesn't stay on the
map for too long: eventually calling <b>G_ExplodeMissile()</b> to clean
up.
<p>Giving the player a homing missile detector that beeps when a lock on
is gained would balance things up a bit. The more advanced might even
want to add this as a powerup like the medikit or teleporter.
<p>
</td>
</tr>
</table>

</tr>
</table>
<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial34.shtml.html"><< Prev</a> |
Tutorial 35 |
<a href="tutorial36.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>

</body>

</html>
