<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>

<head>
<title>Code3Arena</title>
</head>
<body background="../images/bg.gif" bgcolor="#660000" text="white" link="#C05F00" vlink="#d16545"><script type="text/javascript">document.write('<script type="text/javascript" src="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=prestitial"></scr' + 'ipt>');</script>

<table width="100%" border=0 cellpadding=5 cellspacing=0 align="center" background="../images/bg.gif">
<tr>
<td width=728 height=90 align="CENTER" valign="top" bgcolor=#000000>
<center><script language="javascript" type="text/javascript"> 
document.write("<"+"script type='text/javascript' src='http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90'>"); 
document.write("<"+"/script>"); 
</script>
<noscript> 
<iframe valign=top WIDTH=728 HEIGHT=90 MARGINWIDTH=0 MARGINHEIGHT=0 HSPACE=0 VSPACE=0 FRAMEBORDER=0 SCROLLING=no BORDERCOLOR="#000000" SRC="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90&amp;sizew=728&amp;sizeh=90&amp;js=false"> 
</iframe> 
</noscript> </center>
</td>
</tr>
</table>

<br>

<table width="100%" cellspacing="0" cellpadding="0" border="1" align="center" bgcolor=#000000>
<tr>
<td align="CENTER">
<img src="../images/logo.gif" width="500" height="137" border="0" alt="Code3Arena">
</td>
</tr>
</table>

<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial4.shtml.html"><< Prev</a> |
Tutorial 5 |
<a href="tutorial6.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>


<table width="100%" border=0 cellpadding=0 cellspacing=0 align=center bgcolor=#4B0202>
<tr>

<td valign=top bgcolor="#000000">
<table width=150 bgcolor="#000000" valign=top border=0 cellpadding=10 cellspacing=0>
<tr>
<td bgcolor=#000000 valign=top>
<p>
<a href="https://www.quakewiki.net/archives/code3arena/index.shtml"><img src="../images/minilogo.gif" width="150" height="80" border="0" alt="menu"></a>
<p>
<font face=arial color="#C05F00" size=2>
<strong>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/index.shtml">Home/News</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/modsource.shtml">ModSource</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/compilers.shtml">Compiling</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/help.shtml">Help!!!</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/submission.shtml">Submission</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/contributors.shtml">Contributors</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/staff.shtml">Staff</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/downloads.shtml">Downloads</a>
</strong>
<P>
<img src="../images/tutorials.gif" width="80" height="25" border="0" alt="Tutorials">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="index.html"> < Index ></a>
<BR> 1. <a href="tutorial1.shtml.html">Mod making 101</a>
<BR> 2. <a href="tutorial2.shtml.html">Up 'n running</a>
<BR> 3. <a href="tutorial3.shtml.html">Hello, QWorld!</a>
<BR> 4. <a href="tutorial4.shtml.html">Infinite Haste</a>
<BR> 5. <a href="tutorial5.shtml.html">Armor Piercing Rails</a>
<BR> 6. <a href="tutorial6.shtml.html">Bouncing Rockets</a>
<BR> 7. <a href="tutorial7.shtml.html">Cloaking</a>
<BR> 8. <a href="tutorial8.shtml.html">Ladders</a>
<BR> 9. <a href="tutorial9.shtml.html">Favourite Server</a>
<BR> 10. <a href="tutorial10.shtml.html">Flame Thrower</a>
<BR> 11. <a href="tutorial11.shtml.html">Vortex Grenades</a>
<BR> 12. <a href="tutorial12.shtml.html">Grapple</a>
<BR> 13. <a href="tutorial13.shtml.html">Lightning Discharge</a>
<BR> 14. <a href="tutorial14.shtml.html">Locational Damage</a>
<BR> 15. <a href="tutorial15.shtml.html">Leg Shots</a>
<BR> 16. <a href="tutorial16.shtml.html">Weapon Switching</a>
<BR> 17. <a href="tutorial17.shtml.html">Scoreboard frag-rate</a>
<BR> 18. <a href="tutorial18.shtml.html">Vortex Grenades II</a>
<BR> 19. <a href="tutorial19.shtml.html">Vulnerable Missiles</a>
<BR> 20. <a href="tutorial20.shtml.html">Creating Classes</a>
<BR> 21. <a href="tutorial21.shtml.html">Scrolling Credits</a>
<BR> 22. <a href="tutorial22.shtml.html">Weapon Dropping</a>
<BR> 23. <a href="tutorial23.shtml.html">Anti-Gravity Boots</a>
<BR> 24. <a href="tutorial24.shtml.html">HUD scoreboard</a>
<BR> 25. <a href="tutorial25.shtml.html">Flashlight and laser</a>
<BR> 26. <a href="tutorial26.shtml.html">Weapon Positioning</a>
<BR> 27. <a href="tutorial27.shtml.html">Weapon Reloading</a>
<BR> 28. <a href="tutorial28.shtml.html">Progressive Zooming</a>
<BR> 29. <a href="tutorial29.shtml.html">Rotating Doors</a>
<BR> 30. <a href="tutorial30.shtml.html">Beheading (headshot!)</a>
<BR> 31. <a href="tutorial31.shtml.html">Alt Weapon Fire</a>
<BR> 32. <a href="tutorial32.shtml.html">Popup Menus I</a>
<BR> 33. <a href="tutorial33.shtml.html">Popup Menus II</a>
<BR> 34. <a href="tutorial34.shtml.html">Cluster Grenades</a>
<BR> 35. <a href="tutorial35.shtml.html">Homing Rockets</a>
<BR> 36. <a href="tutorial36.shtml.html">Spreadfire Powerup</a>
<BR> 37. <a href="tutorial37.shtml.html">Instagib gameplay</a>
<BR> 38. <a href="tutorial38.shtml.html">Accelerating rockets</a>
<BR> 39. <a href="tutorial39.shtml.html">Server only Instagib</a>
<BR> 40. <a href="tutorial40.shtml.html">Advanced Grapple Hook</a>
<BR> 41. <a href="tutorial41.shtml.html">Unlagging your mod</a>
</strong>
</font>
<p><br>
<img src="../images/articles.gif" width="80" height="25" border="0" alt="Articles">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="https://www.quakewiki.net/archives/code3arena/articles/index.html"> < Index > </a>
<BR> 1. <a href="https://www.quakewiki.net/archives/code3arena/articles/article1.shtml">Entities</A>
<BR> 2. <a href="https://www.quakewiki.net/archives/code3arena/articles/article2.shtml">Vectors</A>
<BR> 3. <a href="https://www.quakewiki.net/archives/code3arena/articles/article3.shtml">Good Coding</A>
<BR> 4. <a href="https://www.quakewiki.net/archives/code3arena/articles/article4.shtml">Compilers I</A>
<BR> 5. <a href="https://www.quakewiki.net/archives/code3arena/articles/article5.shtml">Compilers II</A>
<BR> 6. <a href="https://www.quakewiki.net/archives/code3arena/articles/article6.shtml">UI Menu Primer I</A>
<BR> 7. <a href="https://www.quakewiki.net/archives/code3arena/articles/article7.shtml">UI Menu Primer II</A>
<BR> 8. <a href="https://www.quakewiki.net/archives/code3arena/articles/article8.shtml">UI Menu Primer III</A>
<BR> 9. <a href="https://www.quakewiki.net/archives/code3arena/articles/article9.shtml">QVM Communication, Cvars, commands</A>
<BR> 10. <a href="https://www.quakewiki.net/archives/code3arena/articles/article10.shtml">Metrowerks CodeWarrior</A>
<BR> 11. <a href="https://www.quakewiki.net/archives/code3arena/articles/article11.shtml">1.27g code, bugs, batch</A>
</strong>
</font>
<p>

<br>
<img src="../images/links.gif" width="80" height="25" border="0" alt="Links">
<font color="#C05F00">
<small>
<li><a href="http://www.planetquake.com/quake3/files.shtml">Quake3 Files</a>
<li><a href="http://forums.planetquake.com/">Quake3 Forums</a>
<li><a href="tutorial5.shtml.html#">Q3A Editing Message Board</a>
<li><a href="http://www.planetquake.com/quake3/hosted/editing.shtml">Quake3 Editing</a>
</small>
</font>
<p><br>
<img src="../images/feedback.gif" width="80" height="25" border="0" alt="Feedback">
<font color="#C05F00">
<small>
<li><a href="mailto:sumfuka@planetquake.com">SumFuka</A>
<li><a href="mailto:calrathan@captured.com">Calrathan</A>
<li><a href="mailto:hypothermia@planetquake.com">
<font color="#FF0000">H</font><font color="#FFFF00">y</font><font color="#CC33CC">p</font><font color="#3333FF">o</font>Thermia
</A>
<li><a href="mailto:warzone@planetquake.com">WarZone</A>
</small>
</font>
<p><br>
<p><br><br><br>
<small>Site Design by:</small>
<br>
<a href="mailto:ladyice@planetice.org,jeh@planetjeh.com"><img src="../images/icelogo_sm.jpg" width="88" height="31" border="0" align="middle" alt="ICEmosis Design"></a>
</font>
<br><br>
</td>
</tr>
</table>
</td>


<td valign=top background="../images/bg.gif">
<table width=20 cellpadding=0 cellspacing=0 border=0 background="../images/bg.gif">
<tr>
<td background="../images/bg.gif">
&nbsp;
</td>
</tr>
</table>
</td>


<td valign=top bgcolor=#000000>
<table width="100%" cellpadding=15 cellspacing=10 border=0 bgcolor=#000000 valign=top>
<tr>
<td valign=top>
<font face="Verdana, Arial" size="2" color="#eeeeee">
<center><b><font color="#C05F00" size=5>
TUTORIAL 5 - ARMOR PIERCING RAILS
</font></b><br>by <b><a href="mailto:sumfuka@planetquake.com">SumFuka</A></b></center><p>
Do you get frustrated when the enemy you've got aimed up for a rail in the head suddenly ducks behind a pillar ?? Let's teach the chicken-shit a lesson.<P>
If you like, go and have a read about <a href="https://www.quakewiki.net/archives/code3arena/articles/article2.shtml">Vectors</A>. (Like it or not, a good understanding of vector mathematics is essential to quake coding).<P>
<font color="#E07F44"><H4>
1. HOW DO SLUGS WORK ?
</H4></font>
Let's find the <b>weapon_railgun_fire</b> function at line 334 in g_weapon.c :
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
/*
=================
weapon_railgun_fire
=================
*/
#define	MAX_RAIL_HITS	4
void weapon_railgun_fire (gentity_t *ent) {
	vec3_t		end;
	trace_t		trace;
	gentity_t	*tent;
	gentity_t	*traceEnt;
	int			damage;
	int			radiusDamage;
	int			i;
	int			hits;
	int			unlinked;
	gentity_t	*unlinkedEntities[MAX_RAIL_HITS];

	damage = 100 * s_quadFactor;
	radiusDamage = 30 * s_quadFactor;

	VectorMA (muzzle, 8192, forward, end);

	// trace only against the solids, so the railgun will go through people
	unlinked = 0;
	hits = 0;
	do {
		trap_Trace (&trace, muzzle, NULL, NULL, end, ent->s.number, MASK_SHOT );
		if ( trace.entityNum >= ENTITYNUM_MAX_NORMAL ) {
			break;
		}
		traceEnt = &g_entities[ trace.entityNum ];
		if ( traceEnt->takedamage ) {
			if( LogAccuracyHit( traceEnt, ent ) ) {
				hits++;
			}
			G_Damage (traceEnt, ent, ent, forward, trace.endpos, damage, 0,
			MOD_RAILGUN);
		}
		if ( trace.contents & CONTENTS_SOLID ) {
			break;		// we hit something solid enough to stop the beam
		}
		// unlink this entity, so the next trace will go past it
		trap_UnlinkEntity( traceEnt );
		unlinkedEntities[unlinked] = traceEnt;
		unlinked++;
	} while ( unlinked < MAX_RAIL_HITS );

	// link back in any entities we unlinked
	for ( i = 0 ; i < unlinked ; i++ ) {
		trap_LinkEntity( unlinkedEntities[i] );
	}

	// the final trace endpos will be the terminal point of the rail trail

	// snap the endpos to integers to save net bandwidth, but nudged towards the line
	SnapVectorTowards( trace.endpos, muzzle );

	// send railgun beam effect
	tent = G_TempEntity( trace.endpos, EV_RAILTRAIL );

	// set player number for custom colors on the railtrail
	tent->s.clientNum = ent->s.clientNum;

	VectorCopy( muzzle, tent->s.origin2 );
	// move origin a bit to come closer to the drawn gun muzzle
	VectorMA( tent->s.origin2, 4, right, tent->s.origin2 );
	VectorMA( tent->s.origin2, -1, up, tent->s.origin2 );

	// no explosion at end if SURF_NOIMPACT, but still make the trail
	if ( trace.surfaceFlags & SURF_NOIMPACT ) {
		tent->s.eventParm = 255;	// don't make the explosion at the end
	} else {
		tent->s.eventParm = DirToByte( trace.plane.normal );
	}
	tent->s.clientNum = ent->s.clientNum;

	// give the shooter a reward sound if they have made two railgun hits in a row
	if ( hits == 0 ) {
		// complete miss
		ent->client->accurateCount = 0;
	} else {
		// check for "impressive" reward sound
		ent->client->accurateCount += hits;
		if ( ent->client->accurateCount >= 2 ) {
			ent->client->accurateCount -= 2;
			ent->client->ps.persistant[PERS_REWARD_COUNT]++;
			ent->client->ps.persistant[PERS_REWARD] = REWARD_IMPRESSIVE;
			ent->client->ps.persistant[PERS_IMPRESSIVE_COUNT]++;
			// add the sprite over the player's head
			ent->client->ps.eFlags &= ~(EF_AWARD_IMPRESSIVE |
			EF_AWARD_EXCELLENT | EF_AWARD_GAUNTLET );
			ent->client->ps.eFlags |= EF_AWARD_IMPRESSIVE;
			ent->client->rewardTime = level.time + REWARD_SPRITE_TIME;
		}
		ent->client->ps.persistant[PERS_ACCURACY_HITS]++;
	}

}
</pre></font>
Firstly, assume that 'muzzle' is a location vector just in front of the firer, and 'forward' is a direction vector pointing in the direction the client is facing.<P>
Ok, there's a loop here that basically says do { trace the slug until you hit something; if the slug hits a wall, exit the loop; repeat; }. The <b>do { }</b> simply repeats everything in the curly brackets until the code <b>break</b>'s out. Inside this loop, the first line calls the function <b>trap_Trace(blah blah blah)</b> - this traces a line through space from the origin (muzzle) in the direction of the rail (forward) for a maximum distance of 8192 units. If we hit something, trace returns information about what we hit.<P>
If the slug hits nothing, the do loop simply exits. If the slug hits something damageable ( <b>if (traceEnt->takedamage)</b>, e.g. a player or a button ) then the target is damaged (with G_Damage). If the slug hits a wall or the 'edge of the world' ( <b>if ( trace.entityNum >= ENTITYNUM_MAX_NORMAL )</b> ) then the loop exits. We want to change this !!
<font color="#E07F44"><H4>
2. FIRE THROUGH WALLS
</H4></font>
First we need to a new vector variable (directly below the other variables, near the top of the function). After line 344, add :
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
void weapon_railgun_fire (gentity_t *ent) {
	vec3_t		end;
	trace_t		trace;
	gentity_t	*tent;
	gentity_t	*traceEnt;
	int			damage;
	int			radiusDamage;
	int			i;
	int			hits;
	int			unlinked;
	gentity_t	*unlinkedEntities[MAX_RAIL_HITS];
<font color="#ff6060">	vec3_t		tracefrom;	// SUM</font>
</pre></font>
A few lines down we can see a 'VectorMA' function call. This creates an 'end' vector that is 8192 units 'forward' of 'muzzle' (the startpoint for the rail). We need to make a copy of 'muzzle' in 'tracefrom', so add a line so that your code looks like this :
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
	damage = 100 * s_quadFactor;
	radiusDamage = 30 * s_quadFactor;

	VectorMA (muzzle, 8192, forward, end);
<font color="#ff6060">	VectorCopy (muzzle, tracefrom);</font>
</pre></font>
Next, let's change the trap_Trace function call so that the railgun is traced from 'tracefrom' (instead of muzzle)... there's a good reason for this, read on.
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
	// trace only against the solids, so the railgun will go through people
	unlinked = 0;
	hits = 0;
	do {
<font color="#ff6060">		trap_Trace (&trace, tracefrom, NULL, NULL, end, ent->s.number, MASK_SHOT );</font>
</pre></font>
Next, we want to change the behaviour of the <b>if ( trace.entityNum >= ENTITYNUM_MAX_NORMAL ) { ... }</b> block. This if statement detects if our rail slug runs into a 'solid' (e.g. a wall or the sky).
What do we want to change ? Well, instead of simply 'breaking' out of the do loop (and marking the endpoint for our slug), we want the slug to keep going through walls. Of course, we still want the slug to stop when we hit the sky. The code for this is :
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
		if ( trace.entityNum >= ENTITYNUM_MAX_NORMAL ) {
<font color="#ff6060">			// SUM break if we hit the sky
			if (trace.surfaceFlags & SURF_SKY)
				break;

			// Hypo: break if we traversed length of vector tracefrom
			if (trace.fraction == 1.0)
				break;

			// otherwise continue tracing thru walls
			VectorMA (trace.endpos,1,forward,tracefrom);
			continue;</font>
		}
		traceEnt = &g_entities[ trace.entityNum ];
</pre></font>
In other words, if we hit the sky (check the surfaceFlags), stop. If we've travelled the full length of the vector
then we also need to stop (there's no guarantee we'll ever hit the sky.) Otherwise we've hit a solid wall.
We set our new 'tracefrom' position 1 unit forward of the impact point (which effectively tunnels through the wall). The loop then repeats - <b>continue;</b> takes us back to the top of the 'do' loop.<p>
<font color="#E07F44"><H4>
3. CAN EVERYONE SEE IT ??
</H4></font>
Thanks to <A HREF="mailto:warzone@planetquake.com">WarZone</A> for this section : as it is, the railgun trail is possibly not seen by people far away on the level. The little addition below makes sure that the rail trail entity is 'broadcast' to everyone (not just those in the vicinity of the firer). This makes sense, it would be stupid to have a railgun fire through a wall and frag someone if the victim couldn't see the rail trail !
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
	// no explosion at end if SURF_NOIMPACT, but still make the trail
	if ( trace.surfaceFlags & SURF_NOIMPACT ) {
		tent->s.eventParm = 255;	// don't make the explosion at the end
	} else {
		tent->s.eventParm = DirToByte( trace.plane.normal );
	}
	tent->s.clientNum = ent->s.clientNum;

<font color="#ff6060">	//send the effect to everyone since it tunnels through walls
	tent->r.svFlags |= SVF_BROADCAST;</font>
</pre></font>
I've asked Mark (WarZone) to write an article for us, explaining how 'broadcasting' works and the deeper subject of what goes on in the quake network code. Look out for some more great stuff from him!<P>
Ok, the rest of the function remains the same, and our railgun should fire through walls.<P>
Fire up q3tourney6 and see if you can give Xearo a surprise with your new toy on Nightmare!. "He is got t'go DOWN, man".
<p>
</td>
</tr>
</table>

</tr>
</table>
<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial4.shtml.html"><< Prev</a> |
Tutorial 5 |
<a href="tutorial6.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>

</body>

</html>
