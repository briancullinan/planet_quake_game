<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>

<head>
<title>Code3Arena</title>
</head>
<body background="../images/bg.gif" bgcolor="#660000" text="white" link="#C05F00" vlink="#d16545"><script type="text/javascript">document.write('<script type="text/javascript" src="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=prestitial"></scr' + 'ipt>');</script>

<table width="100%" border=0 cellpadding=5 cellspacing=0 align="center" background="../images/bg.gif">
<tr>
<td width=728 height=90 align="CENTER" valign="top" bgcolor=#000000>
<center><script language="javascript" type="text/javascript"> 
document.write("<"+"script type='text/javascript' src='http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90'>"); 
document.write("<"+"/script>"); 
</script>
<noscript> 
<iframe valign=top WIDTH=728 HEIGHT=90 MARGINWIDTH=0 MARGINHEIGHT=0 HSPACE=0 VSPACE=0 FRAMEBORDER=0 SCROLLING=no BORDERCOLOR="#000000" SRC="http://wrapper.gamespy.com/a?pagetype=pnh_content&amp;size=728x90&amp;sizew=728&amp;sizeh=90&amp;js=false"> 
</iframe> 
</noscript> </center>
</td>
</tr>
</table>

<br>

<table width="100%" cellspacing="0" cellpadding="0" border="1" align="center" bgcolor=#000000>
<tr>
<td align="CENTER">
<img src="../images/logo.gif" width="500" height="137" border="0" alt="Code3Arena">
</td>
</tr>
</table>

<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial33.shtml.html"><< Prev</a> |
Tutorial 34 |
<a href="tutorial35.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>


<table width="100%" border=0 cellpadding=0 cellspacing=0 align=center bgcolor=#4B0202>
<tr>

<td valign=top bgcolor="#000000">
<table width=150 bgcolor="#000000" valign=top border=0 cellpadding=10 cellspacing=0>
<tr>
<td bgcolor=#000000 valign=top>
<p>
<a href="https://www.quakewiki.net/archives/code3arena/index.shtml"><img src="../images/minilogo.gif" width="150" height="80" border="0" alt="menu"></a>
<p>
<font face=arial color="#C05F00" size=2>
<strong>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/index.shtml">Home/News</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/modsource.shtml">ModSource</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/compilers.shtml">Compiling</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/help.shtml">Help!!!</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/submission.shtml">Submission</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/contributors.shtml">Contributors</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/staff.shtml">Staff</a>
<LI> <a href="https://www.quakewiki.net/archives/code3arena/downloads.shtml">Downloads</a>
</strong>
<P>
<img src="../images/tutorials.gif" width="80" height="25" border="0" alt="Tutorials">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="index.html"> < Index ></a>
<BR> 1. <a href="tutorial1.shtml.html">Mod making 101</a>
<BR> 2. <a href="tutorial2.shtml.html">Up 'n running</a>
<BR> 3. <a href="tutorial3.shtml.html">Hello, QWorld!</a>
<BR> 4. <a href="tutorial4.shtml.html">Infinite Haste</a>
<BR> 5. <a href="tutorial5.shtml.html">Armor Piercing Rails</a>
<BR> 6. <a href="tutorial6.shtml.html">Bouncing Rockets</a>
<BR> 7. <a href="tutorial7.shtml.html">Cloaking</a>
<BR> 8. <a href="tutorial8.shtml.html">Ladders</a>
<BR> 9. <a href="tutorial9.shtml.html">Favourite Server</a>
<BR> 10. <a href="tutorial10.shtml.html">Flame Thrower</a>
<BR> 11. <a href="tutorial11.shtml.html">Vortex Grenades</a>
<BR> 12. <a href="tutorial12.shtml.html">Grapple</a>
<BR> 13. <a href="tutorial13.shtml.html">Lightning Discharge</a>
<BR> 14. <a href="tutorial14.shtml.html">Locational Damage</a>
<BR> 15. <a href="tutorial15.shtml.html">Leg Shots</a>
<BR> 16. <a href="tutorial16.shtml.html">Weapon Switching</a>
<BR> 17. <a href="tutorial17.shtml.html">Scoreboard frag-rate</a>
<BR> 18. <a href="tutorial18.shtml.html">Vortex Grenades II</a>
<BR> 19. <a href="tutorial19.shtml.html">Vulnerable Missiles</a>
<BR> 20. <a href="tutorial20.shtml.html">Creating Classes</a>
<BR> 21. <a href="tutorial21.shtml.html">Scrolling Credits</a>
<BR> 22. <a href="tutorial22.shtml.html">Weapon Dropping</a>
<BR> 23. <a href="tutorial23.shtml.html">Anti-Gravity Boots</a>
<BR> 24. <a href="tutorial24.shtml.html">HUD scoreboard</a>
<BR> 25. <a href="tutorial25.shtml.html">Flashlight and laser</a>
<BR> 26. <a href="tutorial26.shtml.html">Weapon Positioning</a>
<BR> 27. <a href="tutorial27.shtml.html">Weapon Reloading</a>
<BR> 28. <a href="tutorial28.shtml.html">Progressive Zooming</a>
<BR> 29. <a href="tutorial29.shtml.html">Rotating Doors</a>
<BR> 30. <a href="tutorial30.shtml.html">Beheading (headshot!)</a>
<BR> 31. <a href="tutorial31.shtml.html">Alt Weapon Fire</a>
<BR> 32. <a href="tutorial32.shtml.html">Popup Menus I</a>
<BR> 33. <a href="tutorial33.shtml.html">Popup Menus II</a>
<BR> 34. <a href="tutorial34.shtml.html">Cluster Grenades</a>
<BR> 35. <a href="tutorial35.shtml.html">Homing Rockets</a>
<BR> 36. <a href="tutorial36.shtml.html">Spreadfire Powerup</a>
<BR> 37. <a href="tutorial37.shtml.html">Instagib gameplay</a>
<BR> 38. <a href="tutorial38.shtml.html">Accelerating rockets</a>
<BR> 39. <a href="tutorial39.shtml.html">Server only Instagib</a>
<BR> 40. <a href="tutorial40.shtml.html">Advanced Grapple Hook</a>
<BR> 41. <a href="tutorial41.shtml.html">Unlagging your mod</a>
</strong>
</font>
<p><br>
<img src="../images/articles.gif" width="80" height="25" border="0" alt="Articles">
<font color="#C05F00" size=1>
<strong>
<BR> <a href="https://www.quakewiki.net/archives/code3arena/articles/index.html"> < Index > </a>
<BR> 1. <a href="https://www.quakewiki.net/archives/code3arena/articles/article1.shtml">Entities</A>
<BR> 2. <a href="https://www.quakewiki.net/archives/code3arena/articles/article2.shtml">Vectors</A>
<BR> 3. <a href="https://www.quakewiki.net/archives/code3arena/articles/article3.shtml">Good Coding</A>
<BR> 4. <a href="https://www.quakewiki.net/archives/code3arena/articles/article4.shtml">Compilers I</A>
<BR> 5. <a href="https://www.quakewiki.net/archives/code3arena/articles/article5.shtml">Compilers II</A>
<BR> 6. <a href="https://www.quakewiki.net/archives/code3arena/articles/article6.shtml">UI Menu Primer I</A>
<BR> 7. <a href="https://www.quakewiki.net/archives/code3arena/articles/article7.shtml">UI Menu Primer II</A>
<BR> 8. <a href="https://www.quakewiki.net/archives/code3arena/articles/article8.shtml">UI Menu Primer III</A>
<BR> 9. <a href="https://www.quakewiki.net/archives/code3arena/articles/article9.shtml">QVM Communication, Cvars, commands</A>
<BR> 10. <a href="https://www.quakewiki.net/archives/code3arena/articles/article10.shtml">Metrowerks CodeWarrior</A>
<BR> 11. <a href="https://www.quakewiki.net/archives/code3arena/articles/article11.shtml">1.27g code, bugs, batch</A>
</strong>
</font>
<p>

<br>
<img src="../images/links.gif" width="80" height="25" border="0" alt="Links">
<font color="#C05F00">
<small>
<li><a href="http://www.planetquake.com/quake3/files.shtml">Quake3 Files</a>
<li><a href="http://forums.planetquake.com/">Quake3 Forums</a>
<li><a href="tutorial34.shtml.html#">Q3A Editing Message Board</a>
<li><a href="http://www.planetquake.com/quake3/hosted/editing.shtml">Quake3 Editing</a>
</small>
</font>
<p><br>
<img src="../images/feedback.gif" width="80" height="25" border="0" alt="Feedback">
<font color="#C05F00">
<small>
<li><a href="mailto:sumfuka@planetquake.com">SumFuka</A>
<li><a href="mailto:calrathan@captured.com">Calrathan</A>
<li><a href="mailto:hypothermia@planetquake.com">
<font color="#FF0000">H</font><font color="#FFFF00">y</font><font color="#CC33CC">p</font><font color="#3333FF">o</font>Thermia
</A>
<li><a href="mailto:warzone@planetquake.com">WarZone</A>
</small>
</font>
<p><br>
<p><br><br><br>
<small>Site Design by:</small>
<br>
<a href="mailto:ladyice@planetice.org,jeh@planetjeh.com"><img src="../images/icelogo_sm.jpg" width="88" height="31" border="0" align="middle" alt="ICEmosis Design"></a>
</font>
<br><br>
</td>
</tr>
</table>
</td>


<td valign=top background="../images/bg.gif">
<table width=20 cellpadding=0 cellspacing=0 border=0 background="../images/bg.gif">
<tr>
<td background="../images/bg.gif">
&nbsp;
</td>
</tr>
</table>
</td>


<td valign=top bgcolor=#000000>
<table width="100%" cellpadding=15 cellspacing=10 border=0 bgcolor=#000000 valign=top>
<tr>
<td valign=top>
<font face="Verdana, Arial" size="2" color="#eeeeee">
<center><b><font color="#C05F00" size=5>
TUTORIAL 34 - Cluster grenades
</font></b><br>by <b><a href="mailto:chris@dctank.com">Chris Hilton</A></b></center><p>
<p>Powering up the weapons that already exist is an excellent way to introduce yourself
to the code. Game balance is always an issue here, but you can have a lot of fun with this
in a LAN party as you frag your friends in devious and gratuitous ways.
<p>The grenade launcher is a difficult weapon to use well. The ordnance is unpowered and
falls under gravity, and it bounces too. This tute powers up the grenade launcher to create a
lethal area to try and run or jump over. Especially deadly in corridors!
<p>This tutorial updates the cluster grenade work by SumFuka at QDevels for Q2, bringing it
in line with the new Q3 code. Chris Hilton wrote the code and donated the mod source to Code3Arena,
and <font color="#FF0000">H</font><font color="#FFFF00">y</font><font color="#CC33CC">p</font><font color="#3333FF">o</font><font color="#FFFFFF">Thermia</font>
wrote these words.
<p>The coding modifications are all in <b>g_missile.c</b>, with one addition to <b>g_local.h</b>.
<p>&nbsp;
<font color="#E07F44"><H4>
1. The cluster grenade design
</H4></font>
<p>When we create entities that exist on the map for a short duration,
such as fired weapon ordnance, there's a framework already in place for
us to use. Such items are called "Bolts" (the name given to crossbow
ammunition). A lot of work has already been done for us to make sure
they move through the map smoothly, either under their own power, or on
a gravitational trajectory.
<p>The bolt system can be easily extended to create new types, or separate out
similar types of ammo (as we're doing here). A cluster grenade looks like any
other grenade, but has the effect of breaking up on impact or after a time delay,
so we need two types of ammo. Fortunately the bolt system allows us to add
new types with ease.
<p>&nbsp;
<font color="#E07F44"><H4>
2. The code
</H4></font>
<p>We'll start by creating our new type of bolt ammunition, by modifying the ammo fired
by the grenade launcher.
We make this change to <b>fire_grenade()</b> in <b>g_missile.c</b>:
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
bolt = G_Spawn();
<font color="#ff6060">bolt->classname = "cgrenade";	// CCH</font>
bolt->nextthink = level.time + 2500;
</pre></font>
<p>By renaming our bolt we've created a new type, thats the minimum you need to do! The bolt
is a <b>gentity_t</b> which is an entity created with <b>G_Spawn()</b>. This data
structure is only used in this form within the server code, so it can get away with using
a pointer to the string name.
<p>Setting the item type to <b>ET_MISSILE</b> ensures that the <b>G_MissileImpact()</b>
function is called. Inside <b>G_MissileImpact()</b> we have to create the
cluster of grenades when something is hit. We need a vector for the direction that
each grenade will go in:
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
gentity_t	*other;
qboolean	hitClient = qfalse;
<font color="#ff6060">vec3_t		dir;			// CCH</font>
</pre></font>
<p>Then the code that recognizes the type of bolt and creates the grenades. This uses
a function <b>fire_grenade2()</b> we'll provide in a moment:
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
// splash damage (doesn't apply to person directly hit)
if ( ent->splashDamage ) {
	if( G_RadiusDamage( trace->endpos, ent->parent, 
			ent->splashDamage, ent->splashRadius, 
			other, ent->splashMethodOfDeath ) ) {
		if( !hitClient ) {
			g_entities[ent->r.ownerNum].client->
				ps.persistant[PERS_ACCURACY_HITS]++;
		}
	}
}

<font color="#ff6060">// CCH: For cluster grenades
if (!strcmp(ent->classname, "cgrenade")) {
	VectorSet(dir, 20, 20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
	VectorSet(dir, -20, 20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
	VectorSet(dir, 20, -20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
	VectorSet(dir, -20, -20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
}</font>

trap_LinkEntity( ent );
</pre></font>
<p>&nbsp;
<p>The vector <b>dir</b> contains the velocity in which each fragment will move: four diagonal
directions and a small kick vertically so they bounce nicely.
<p>Now we need to provide the functionality within the "think" function, called when
the game time reaches the <b>nextthink</b> time. The grenade has "timed out" and broken
into equally lethal fragments.
<p>Adding to <b>G_ExplodeMissile()</b> the same code as we put into <b>G_MissileImpact()</b>
gives the required effect. If you plan to develop or extend cluster grenades then it would
be wise to merge this identical code into a single function. This would give the same effect
with either event, without having to copy/paste code back and forth.
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
// splash damage
if ( ent->splashDamage ) {
	if( G_RadiusDamage( ent->r.currentOrigin, ent->parent, 
			ent->splashDamage, ent->splashRadius, NULL
			, ent->splashMethodOfDeath ) ) {
		g_entities[ent->r.ownerNum].client->
			ps.persistant[PERS_ACCURACY_HITS]++;
	}
}

<font color="#ff6060">// CCH: For cluster grenades
if (!strcmp(ent->classname, "cgrenade")) {
	VectorSet(dir, 20, 20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
	VectorSet(dir, -20, 20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
	VectorSet(dir, 20, -20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
	VectorSet(dir, -20, -20, 40);
	fire_grenade2(ent->parent, ent->r.currentOrigin, dir);
}</font>

trap_LinkEntity( ent );
</pre></font>
<p>&nbsp;
<p>Just the creation of each grenade in the cluster needed now. This is done using the
new function <b>fire_grenade2()</b>, which is best placed just before <b>fire_grenade()</b>.
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre><font color="#ff6060">/*
=================
CCH: fire_grenade2

38: 62. They will also say, `Our Lord, whosoever prepared this for us,
do thou multiply manifold his punishment in the Fire.'
--Holy Quran, translated by Maulvi Sher Ali  
=================
*/
gentity_t *fire_grenade2 (gentity_t *self, vec3_t start, vec3_t dir) {
	gentity_t	*bolt;

	VectorNormalize (dir);

	bolt = G_Spawn();
	bolt->classname = "grenade";
	bolt->nextthink = level.time + 2500;
	bolt->think = G_ExplodeMissile;
	bolt->s.eType = ET_MISSILE;
	bolt->r.svFlags = SVF_USE_CURRENT_ORIGIN;
	bolt->s.weapon = WP_GRENADE_LAUNCHER;
	bolt->s.eFlags = EF_BOUNCE_HALF;
	bolt->r.ownerNum = self->s.number;
	bolt->parent = self;
	bolt->damage = 100;
	bolt->splashDamage = 100;
	bolt->splashRadius = 150;
	bolt->methodOfDeath = MOD_GRENADE;
	bolt->splashMethodOfDeath = MOD_GRENADE_SPLASH;
	bolt->clipmask = MASK_SHOT;

	bolt->s.pos.trType = TR_GRAVITY;

	// move a bit on the very first frame
	bolt->s.pos.trTime = level.time - MISSILE_PRESTEP_TIME;

	VectorCopy( start, bolt->s.pos.trBase );
	VectorScale( dir, 700, bolt->s.pos.trDelta );
	
	// save net bandwidth
	SnapVector( bolt->s.pos.trDelta );

	VectorCopy (start, bolt->r.currentOrigin);

	return bolt;
}</font>
</pre></font>
<p>This is almost an exact copy/paste of the original <b>fire_grenade()</b>, but restoring the
original <b>classname</b> for the grenade. If you put "cgrenade" in here then you'd be creating new
clusters of grenades every time, crashing the game before filling the level!
<p>You can tweak these values for slightly different behaviour: the amount of damage and
splash damage for example. The 700 in the <b>VectorScale()</b> determines the speed of the
fragments (and hence how far they can travel). Other ideas include changing the number of fragments,
or a more random disrtibution to the fragments.
<p>&nbsp;
<p>The last thing we need to do is declare the function in <b>g_local.h</b> at about line 454:
<font face="Verdana, Arial" size="3" color="#ffffcc"><pre>
//
// g_missile.c
//
void G_RunMissile( gentity_t *ent );

gentity_t *fire_blaster (gentity_t *self, vec3_t start, vec3_t aimdir);
gentity_t *fire_plasma (gentity_t *self, vec3_t start, vec3_t aimdir);
gentity_t *fire_grenade (gentity_t *self, vec3_t start, vec3_t aimdir);
<font color="#ff6060">gentity_t *fire_grenade2 (gentity_t *self, vec3_t start, vec3_t aimdir);</font>	// CCH	
</pre></font>
<p>&nbsp;
<font color="#E07F44"><H4>
3. All done!
</H4></font>
<p>Now go off and enjoy this souped up weapon! Particularly effective and useful in a CTF
game!
<p>
</td>
</tr>
</table>

</tr>
</table>
<p>

<table width="100%" cellpadding=0 cellspacing=0 border=0 bgcolor="#000000">
<tr>
<td><img src="../images/ouricon.gif"></td>
<td width="100%" bgcolor=#000000>
<font face="Verdana, Arial" size="2" color="#eeeeee"><b>
<A HREF="http://www.planetquake.com/">PlanetQuake</A> |
<A HREF="http://www.planetquake.com/code3arena">Code3Arena</A> |
<A HREF="http://www.planetquake.com/code3arena/tutorials">Tutorials</A> |
<a href="tutorial33.shtml.html"><< Prev</a> |
Tutorial 34 |
<a href="tutorial35.shtml.html">Next >></a>
</b></font>
</td>
</tr>
</table>
<p>

</body>

</html>
